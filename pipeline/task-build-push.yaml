apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-java-app
spec:
  params:
  - name: buildRevision
  - name: destinationImage
    description: Parameter Description
    default: "$(outputs.resources.builtImage.url)"
  resources:
    inputs:
    - name: source
      type: git
    outputs:
    - name: builtImage
      type: image
  workspaces:
  - name: maven-cache

  steps:
  - name: copy-maven-tmp
    image: instrumentisto/rsync-ssh:latest
    script: |
      #!/usr/bin/env sh
      set -e

      echo contents of maven cache $(workspaces.maven-cache.path)
      ls -ahl $(workspaces.maven-cache.path)

      date
      rsync -rz $(workspaces.maven-cache.path)/* /tmp/maven-cache/
      date

      echo contents of tmp cache /tmp/maven-cache/
      ls -ahl /tmp/maven-cache/
    volumeMounts:
    - name: maven-tmp
      mountPath: /tmp/maven-cache/

  - name: build-sources
    image: gcr.io/cloud-builders/mvn
    workingDir: "/workspace/source/coffee-shop/"
    command:
    - /usr/bin/mvn
    args:
#    - -Dmaven.repo.local=$(workspaces.maven-cache.path)
    - -Dmaven.repo.local=/tmp/maven-cache/
    - clean
    - package
    env:
    - name: MAVEN_OPTS
      value: "-Xms2G -Xmx4G"
    resources:
      requests:
        cpu: '2'
        memory: '4Gi'
    volumeMounts:
    - name: maven-tmp
      mountPath: /tmp/maven-cache/

  - name: build-image
    image: quay.io/buildah/stable
    workingDir: "/workspace/source/coffee-shop/"
    command: ['buildah', 'bud', '--tls-verify=false', '--layers', '-f', 'Dockerfile', '-t', '$(inputs.params.destinationImage):$(inputs.params.buildRevision)', '.']
    volumeMounts:
    - name: varlibc
      mountPath: /var/lib/containers
    securityContext:
      allowPrivilegeEscalation: true
      runAsUser: 0
      privileged: true

  - name: build-push
    image: quay.io/buildah/stable
    command: ["buildah", "push", "--tls-verify=false", "$(inputs.params.destinationImage):$(inputs.params.buildRevision)", "docker://$(inputs.params.destinationImage):$(inputs.params.buildRevision)"]
    volumeMounts:
    - name: varlibc
      mountPath: /var/lib/containers
    securityContext:
      allowPrivilegeEscalation: true
      runAsUser: 0
      privileged: true

  - name: write-maven-cache
    image: instrumentisto/rsync-ssh:latest
    script: |
      #!/usr/bin/env sh
      set -e

      echo contents of tmp cache /tmp/maven-cache/
      ls -ahl /tmp/maven-cache/

      date
      rsync -rz /tmp/maven-cache/* $(workspaces.maven-cache.path)
      date

      echo contents of maven cache $(workspaces.maven-cache.path)
      ls -ahl $(workspaces.maven-cache.path)
    volumeMounts:
    - name: maven-tmp
      mountPath: /tmp/maven-cache/

  volumes:
  - name: varlibc
    emptyDir: {}
  - name: maven-tmp
    emptyDir: {}
---
